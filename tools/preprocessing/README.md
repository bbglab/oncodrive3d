# MANE Custom Structure Maintenance

`tools/update_samplesheet_and_structures.py` automates two tightly coupled tasks that keep Oncodrive3D’s custom MANE structures up to date:

1. **Keep the custom MANE PDB folder up to date** so `oncodrive3d build-datasets` can see every structure we have.
   - The fresh predictions plus any matching entries we reuse from the AlphaFold DB canonical PDBs (which already contains the AlphaFold download, both MANE and Ensembl canonical ones).
2. **Refresh the MANE samplesheet + FASTA inputs** (generated by `oncodrive3d preprocessing prepare_samplesheet.py`).
   - So that the next nf-core proteinfold run can focus exclusively on the still-missing ENSPs, after accounting for recent predictions or canonical reuses.

## Installation
Requires [uv](https://github.com/astral-sh/uv) and Python 3.10+.

```bash
uv sync
source .venv/bin/activate
```

## Inputs
All non-runtime configuration still lives in `config.yaml`:

| Field | Description |
| --- | --- |
| `paths.<env>.predicted_dir` | Absolute path to the nf-core/proteinfold run output (raw ENSP PDBs from nf-core). |
| `paths.<env>.predicted_relpath` | Folder (relative to `--samplesheet-folder`) where the curated ENSP bundle lives (the script syncs `predicted_dir` into here). |
| `paths.<env>.missing_relpath` | Folder (relative) that will hold `missing/samplesheet.csv` and `missing/fasta/` for the next nf-core proteinfold run. |
| `paths.<env>.retrieved_relpath` | Folder (relative) where canonical MANE structures reused from the AlphaFold DB canonical PDBs are stored. |
| `paths.<env>.final_bundle_relpath` | Folder (relative) containing the merged `pdbs/` + `samplesheet.csv` passed to `oncodrive3d build-datasets`. |
| `paths.<env>.mane_missing_path` | Absolute path to `mane_missing.csv` (UniProt ↔ RefSeq mapping used for canonical reuse). |
| `paths.<env>.mane_summary_path` | Absolute path to the MANE summary file used to map ENSP ↔ gene symbols. |
| `paths.<env>.cgc_list_path` | Absolute path to the Cancer Gene Census TSV (optional; only needed for CGC prioritisation). |

Runtime arguments are passed via the CLI (see below); `config.yaml` no longer stores `samplesheet_folder` or runtime flags.

## Usage

```bash
python tools/update_samplesheet_and_structures.py \
    --samplesheet-folder <data> \
    [--predicted-dir /path/to/nfcore/pdbs] \
    [--canonical-dir /path/to/af_canonical_pdbs]
```

Arguments:

- `--samplesheet-folder` (required): Folder that contains the MANE samplesheet and FASTAs produced by `prepare_samplesheet.py`.
- `--config-path` (default `config.yaml`): Path to the shared configuration file.
- `--predicted-dir` (optional): Directory containing the latest nf-core/proteinfold predicted ENSP PDBs; omit it if you only want to reuse AF canonical structures and update the missing set.
- `--canonical-dir` (optional): Directory containing the AlphaFold DB canonical PDBs (e.g., `oncodrive3d build-datasets` download merged with AlphaFold data). Required if you want to reuse canonical structures.
- `--max-workers`: Parallel workers for canonical indexing; defaults to all CPUs.
- `--filter-long-sequences/--no-filter-long-sequences` (default enabled): Whether to drop long proteins from the nf-core proteinfold input.
- `--max-sequence-length` (default `2700`): Cutoff (residues) when the long-sequence filter is enabled.

> Provide at least one of `--predicted-dir` or `--canonical-dir`; otherwise the script has no work to perform.

## Workflow

- Sync nf-core proteinfold outputs into a clean `predicted/` bundle under the `prepare_samplesheet.py` folder.
- Copy FASTAs + build `missing/samplesheet.csv` for the next nf-core proteinfold run.
- Reuse any matching entries from the AlphaFold DB canonical PDBs and prune them from the missing set.
- Tag remaining entries with CGC metadata, optionally filter by length, and re-sort.
- Merge `predicted/` (plus any `retrieved/` entries) into the final custom MANE bundle consumed by `oncodrive3d build-datasets`.

> Tip: you can run the script in two passes—first with only `--canonical-dir` (to harvest/prune canonical entries), then again with `--predicted-dir` once the nf-core run finishes to fold those predictions into the final bundle.

## Outputs

After the run, each `<samplesheet_folder>` contains:

- `predicted/`
  - `samplesheet.csv` (predicted ENSPs)
  - `pdbs/ENSP....alphafold.pdb` (structures copied from nf-core proteinfold outputs)
- `missing/`
  - `samplesheet.csv` (prioritised/filtered) → input for the nf-core proteinfold pipeline to predict the remaining ENSPs.
  - `samplesheet_removed_long.csv` (only if filtering removed entries)
  - `fasta/ENSP....fasta` → FASTA files referenced by `missing/samplesheet.csv`.
- `retrieved/`
  - `samplesheet.csv` (retrieved ENSPs)
  - `pdbs/...` (structures retrieved from the AlphaFold DB canonical PDBs produced by `oncodrive3d build-datasets`)
- `final_bundle/`
  - `samplesheet.csv` (deduplicated union of predicted + retrieved) → pass to `oncodrive3d build-datasets --custom_mane_metadata_path`.
  - `pdbs/...` → pass to `oncodrive3d build-datasets --custom_mane_pdb_dir`.

## Next steps

1. **Predict remaining structures**  
   Point the nf-core proteinfold pipeline at `missing/samplesheet.csv` and the companion `missing/fasta/` directory to generate the remaining ENST-based predictions.

2. **Rebuild Oncodrive3D datasets**  
   Once the new predictions (and optional canonical retrievals) are in place, run `oncodrive3d build-datasets` with `--custom_mane_pdb_dir <samplesheet_folder>/final_bundle/pdbs` and `--custom_mane_metadata_path <samplesheet_folder>/final_bundle/samplesheet.csv` to inject the refreshed MANE custom structures into the datasets.
