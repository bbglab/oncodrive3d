# Input

Oncodrive3D analyse patterns of somatic mutations at the cohort level, and relies on two primary input files:

---
- **Input mutations** (`required`): Mutation file that can be either:
   - **<input_maf>**: A Mutation Annotation Format (MAF) file annotated with consequences (e.g., by using [Ensembl Variant Effect Predictor (VEP)](https://www.ensembl.org/info/docs/tools/vep/index.html)).
   - **<input_vep>**: The unfiltered output of VEP including annotations for all possible transcripts.

- **<mut_profile>** (`optional`): Dictionary including the normalized frequencies of mutations (*values*) in every possible trinucleotide context (*keys*), such as 'ACA>A', 'ACC>A', and so on.

---

## Input Mutations

### MAF File

A [Mutation Annotation Format (MAF)](https://docs.gdc.cancer.gov/Data/File_Formats/MAF_Format/#introduction) file that encompasses all somatic mutations identified within a specific cohort and their annotations (e.g., annotated by using Ensembl Variant Effect Predictor (VEP)).

For example, after performing variant calling, it can be generated by VEP using a Variant Call Format (VCF) file as input:

```
vep --dir <vep_data> -i <input_vcf> --offline --cache -o <output>.vep.tsv \
    --species homo_sapiens --assembly GRCh38 --fork 8 --symbol --protein \ 
    --tab --canonical --pick
```

The output of VEP should be filtered so that each mutation is mapped to a single transcript. Additionally, it should be parsed to conform to the MAF format and include at least the following fields:

1. **Hugo_Symbol**: HUGO symbol for the gene.
4. **Variant_Classification**: Translational effect of variant allele.
5. **Transcript_ID**: Ensembl ID of the transcript affected by the variant.
5. **HGVSp_Short**: The protein sequence of the variant in HGVS recommended format using 1-letter amino-acid codes.

### VEP File

To maximize the number of matching transcripts between the input mutations and the AlphaFold predicted structures used by Oncodrive3D, it is recommended to USE the unfiltered output of VEP (generated using the VEP command described in the [MAF file section](#maf-file)) as input.
In this case:

- The file should include all possible transcripts for each mutation without filtering.
- The `--o3d_transcripts` and `--use_input_symbols` flags must be included when running the `oncodrive3d run` command to ensure proper processing and transcript matching with Oncodrive3D's pre-built datasets.

---

> [!WARNING]
> If the VEP output includes header lines starting with ## (commonly found in the VEP output format), it is recommended to remove these lines to ensure compatibility with Oncodrive3D and other downstream tools. You can do this with the following command:
> 
> ```
> grep -v '^##' <cohort>.vep.tsv > <cohort>.vep.tsv
> ```

---

## Mutation Profile

The mutation profile of a cohort rapresents the count or the normalized frequencies of mutations in every possible k-nucleotide (e.g., trinucleotide or pentanucleotide) contexts.

The mutation profile used by Oncodrive3D is a dictionary (json file) including the frequency of mutations (*values*) of the cohort in 192 trinucleotide contexts (*keys*), normalized by the trinucleotide bias:

```json
{
    "GCA>G": 0.02424271083094251,
    "AGC>A": 0.023005887103025254,
    "ACG>T": 0.037613802858829135,
    "CGA>C": 0.10691031051670515,
    "GAC>G": 0.017846071811001615,
    "TTC>A": 0.024003748061871697,
    "CTT>G": 0.024149863672267024,
    "GGA>T": 0.011178562948734577,
    "AGG>C": 0.010654720767868876,
    "GGG>C": 0.012031686292218055,
    "CAA>T": 0.014478959792844522,
    "TGA>A": 0.01255651801972085,
    "GGA>A": 0.011178562948734577,
    "CGA>A": 0.03563677017223505,
    "TCC>T": 0.011158347971568658,
    "GCC>A": 0.010952316565906438,
    // ...
}
```

The mutation profile can be computed using BGSignature or other bioinformatics softwares.  
Below is an example using BGSignature:

### Create the Mutation Profile with BGSignature

**Install BGSignature**
```
pip install bgsignature
```

**Get the count of trinucleotides**
```
bgsignature count -r <regions_file> -s 3 -g GRCh38 --cores 8 --collapse \
                  --exclude-N -o count.gz
```

**Get the frequency of mutations normalized by trinucleotide bias**

```
bgsignature normalize -m <mutations_file> -r <regions_file> --normalize count.gz \ 
                      -s 3 -g GRCh38 --collapse --cores 8 -o <cohort>.sig.json
```

To compute the mutation profile with BGSignature two main files are required:

1. **mutations_file**: Tab Separated File (TSV) including an header and at least the following columns: 
    - `CHROMOSOME`
    - `POSITION`
    - `REF`
    - `ALT`
2. **regions_file**: Tab Separated File (TSV) including the coordinates of the genomic regions (e.g., a panel of genes, the whole exome, or the whole genome) that the user wants to consider for computing the mutation profile. This file should include an header and at least the following columns: 
    - `CHROMOSOME`
    - `START`
    - `END`
    - `ELEMENT`

#### Create the Regions File

The regions file can be generated using BGReference. Below is an example of a Python script to create a regions file for a specified genome and k-mer size.

**Install BGReference**
```
pip install bgreference
```

**Python Script to Generate the Regions File**

Save the following as get_regions_file.py:

```python
import sys
from bgreference import refseq

CHR = [str(i) for i in range(1, 20)] + ['X', 'Y', 'M']


def compute_sizes(genome, kmer):
    sizes = []
    for chr_ in CHR:
        seq = refseq(genome, f"chr{chr_}", start=(1 + kmer // 2), size=None)
        sizes.append(tuple(map(str, (chr_, 1 + kmer // 2, len(seq) - kmer // 2))))
    return sizes


def write(sizes):
    print('\t'.join(('CHROMOSOME', 'START', 'END')))
    for s in sizes:
        print('\t'.join(s))

if __name__ == '__main__':
    genome = sys.argv[1]
    kmer = int(sys.argv[2])
    write(compute_sizes(genome, kmer))
```

**Run the Script**

```
python3 get_regions_file.py hg38 3 > hg38_wg_regions.tsv
```

# Ouput

## Main Output

## Supplementary Output